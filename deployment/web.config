<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    
    <!-- ISAPI Filter Configuration -->
    <isapiFilters>
      <!-- Replace 'YourISAPIFilter.dll' with your actual DLL name -->
      <filter name="DelphiISAPIFilter" 
              path="bin\YourISAPIFilter.dll" 
              enabled="true" 
              enableCache="true" />
    </isapiFilters>
    
    <!-- Handler Mappings for ISAPI -->
    <handlers>
      <!-- ISAPI-dll handler mapping -->
      <add name="ISAPI-dll" 
           path="*.dll" 
           verb="GET,HEAD,POST" 
           modules="IsapiModule" 
           scriptProcessor="" 
           resourceType="File" 
           requireAccess="Execute" 
           allowPathInfo="true" />
      
      <!-- Custom ISAPI handler for specific extensions -->
      <add name="DelphiISAPI" 
           path="*.dapi" 
           verb="*" 
           modules="IsapiModule" 
           scriptProcessor="bin\YourISAPIFilter.dll" 
           resourceType="File" 
           requireAccess="Execute" />
    </handlers>
    
    <!-- Default Documents -->
    <defaultDocument>
      <files>
        <clear />
        <add value="default.htm" />
        <add value="default.html" />
        <add value="default.asp" />
        <add value="index.html" />
        <add value="iisstart.htm" />
      </files>
    </defaultDocument>
    
    <!-- Directory Browsing -->
    <directoryBrowse enabled="false" />
    
    <!-- Request Filtering -->
    <security>
      <requestFiltering>
        <fileExtensions>
          <add fileExtension=".dll" allowed="true" />
          <add fileExtension=".dapi" allowed="true" />
        </fileExtensions>
        <verbs>
          <add verb="GET" allowed="true" />
          <add verb="POST" allowed="true" />
          <add verb="HEAD" allowed="true" />
        </verbs>
        <requestLimits maxAllowedContentLength="104857600" /> <!-- 100MB -->
      </requestFiltering>
    </security>
    
    <!-- Static Content -->
    <staticContent>
      <mimeMap fileExtension=".dapi" mimeType="application/octet-stream" />
    </staticContent>
    
    <!-- HTTP Errors -->
    <httpErrors errorMode="Detailed" />
    
    <!-- URL Rewrite (if needed for legacy URL compatibility) -->
    <!--
    <rewrite>
      <rules>
        <rule name="Legacy ISAPI URLs" stopProcessing="true">
          <match url="^legacy/(.*)$" />
          <action type="Rewrite" url="YourISAPIFilter.dll?{R:1}" />
        </rule>
      </rules>
    </rewrite>
    -->
    
  </system.webServer>
  
  <!-- Application Settings -->
  <appSettings>
    <!-- Azure App Service Environment Variables -->
    <add key="ISAPI_DEBUG_MODE" value="false" />
    <add key="ISAPI_LOG_LEVEL" value="INFO" />
    
    <!-- Azure App Service File System Paths -->
    <!-- These are the actual writable directories in Azure App Service -->
    <add key="SHARED_FOLDER_PATH" value="D:\home\data" />
    <add key="TEMP_FOLDER_PATH" value="D:\local\Temp" />
    <add key="LOG_FOLDER_PATH" value="D:\home\LogFiles\Application" />
    
    <!-- Azure Files Integration (when enabled) -->
    <add key="AZURE_FILES_ENABLED" value="false" />
    <add key="AZURE_FILES_MOUNT_PATH" value="Z:" />
    <add key="AZURE_FILES_SHARE_NAME" value="isapi-shared-folder" />
    
    <!-- Performance and Caching -->
    <add key="WEBSITE_LOAD_USER_PROFILE" value="1" />
    <add key="WEBSITE_DYNAMIC_CACHE" value="0" />
    <add key="WEBSITE_LOCAL_CACHE_OPTION" value="Always" />
    
    <!-- Application Insights Integration -->
    <add key="APPINSIGHTS_INSTRUMENTATIONKEY" value="" />
    <add key="APPLICATIONINSIGHTS_CONNECTION_STRING" value="" />
    <add key="ApplicationInsightsAgent_EXTENSION_VERSION" value="~2" />
    
    <!-- Security Settings -->
    <add key="WEBSITE_LOAD_CERTIFICATES" value="*" />
    <add key="WEBSITE_AUTH_ENABLED" value="false" />
    
    <!-- Database Connection Settings -->
    <add key="DB_CONNECTION_TIMEOUT" value="30" />
    <add key="DB_COMMAND_TIMEOUT" value="120" />
    <add key="DB_RETRY_COUNT" value="3" />
    <add key="DB_RETRY_INTERVAL" value="1" />
    
    <!-- Azure-specific optimizations -->
    <add key="WEBSITE_TIME_ZONE" value="UTC" />
    <add key="WEBSITE_RUN_FROM_PACKAGE" value="1" />
    
    <!-- Important: Review Azure Web App Sandbox restrictions -->
    <!-- https://github.com/projectkudu/kudu/wiki/Azure-Web-App-sandbox#general-sandbox-restrictions -->
  </appSettings>
  
  <!-- Connection Strings (Azure SQL Database) -->
  <connectionStrings>
    <!-- Azure SQL Database connection template -->
    <!-- Replace with your actual Azure SQL Database connection string -->
    <!-- 
    <add name="DefaultConnection" 
         connectionString="Server=tcp:your-server.database.windows.net,1433;Initial Catalog=your-database;Persist Security Info=False;User ID=your-username;Password=your-password;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;" 
         providerName="System.Data.SqlClient" />
    -->
    
    <!-- Azure SQL Database with Managed Identity (Recommended for production) -->
    <!--
    <add name="DefaultConnectionManagedIdentity" 
         connectionString="Server=tcp:your-server.database.windows.net,1433;Initial Catalog=your-database;Persist Security Info=False;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;Authentication=Active Directory Default;" 
         providerName="System.Data.SqlClient" />
    -->
    
    <!-- Azure SQL Database connection pool settings -->
    <!--
    <add name="PooledConnection" 
         connectionString="Server=tcp:your-server.database.windows.net,1433;Initial Catalog=your-database;Persist Security Info=False;User ID=your-username;Password=your-password;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;Max Pool Size=100;Min Pool Size=5;Pooling=true;" 
         providerName="System.Data.SqlClient" />
    -->
  </connectionStrings>
  
  <!-- System.Web Configuration for .NET Framework compatibility -->
  <system.web>
    <compilation debug="false" targetFramework="4.8" />
    <httpRuntime targetFramework="4.8" maxRequestLength="102400" executionTimeout="300" />
    
    <!-- Trust Level -->
    <trust level="Full" />
    
    <!-- Session State (if used by ISAPI) -->
    <sessionState mode="InProc" 
                  cookieless="false" 
                  timeout="20" />
    
    <!-- Custom Errors -->
    <customErrors mode="Off" />
    
    <!-- Authentication (adjust as needed) -->
    <authentication mode="None" />
    
    <!-- Authorization -->
    <authorization>
      <allow users="*" />
    </authorization>
  </system.web>
  
  <!-- Runtime configuration -->
  <runtime>
    <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">
      <!-- Assembly redirects if needed -->
    </assemblyBinding>
  </runtime>
  
</configuration>
